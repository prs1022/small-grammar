# Grammar 项目文档

## 项目概述

Grammar 是一个基于 Java 的语法处理系统，用于解析、编译和匹配语法规则。该项目采用 Maven 多模块结构，支持通过 Docker 容器进行部署。

# 代码分析
1. 加载目录cld文件 , 读取cld文件内容分别实例化 到 sensefiles (SenseFile[]类型) 
2. 对sensefiles 抽象出 NamespaceDeclaration 包含 clause，prime，statement这些declaration
3. 对namespaceDeclaration做内部命名冲突检查
4. 检查 import namespace是否存在， 导入的prime macro or clause实体是否存在 等等
5. sensefiles整体合并到 structure对象中，处理了脚本标志位和debug信息等
6. 利用compiler 对 structure 做编译， compiler可以设置一些参数，例如是否要保留未被引用的clause or prime
7. 编译的结果就是fsm，包含了比较重要的structureAccessor, 和 prime，clause，statment的manager（下面用【实体】称呼 prime，clause，statment， macro， script，expr等等）
8. structureAcc主要是 namespace 和 【实体】 的映射 ，同时处理了 停用词、正则匹配的词，词概率等
9. manager里维护item数组，每个item维护【实体】的顺序，处理 引用关系，创建【实体】的block 填充 manager，重点是block的顺序

## 项目模块

项目由以下主要模块组成：

### 核心模块

1. **base**: 核心数据结构和接口
   - 包含基础数据类型定义
   - 提供命名实体识别(NER)功能
   - 包含语义处理组件
   - 提供词汇表管理功能

2. **structure**: 语法结构定义
   - 定义语法规则的结构表示

3. **parser**: 解析功能
   - 负责将文本格式的语法规则解析为结构化表示

4. **compiler**: 语法编译
   - 将解析后的语法规则编译为可执行形式

5. **matcher**: 模式匹配引擎
   - 负责将输入文本与编译后的语法规则进行匹配

6. **fsm**: 有限状态机实现
   - 用于模式识别的状态机实现

7. **codec**: 编码/解码功能
   - 提供数据编解码功能

### 服务模块

8. **webapi**: Web API 服务器
   - 提供 RESTful API 接口

9. **rpc**: 远程过程调用实现
   - 提供 gRPC 服务接口

10. **console**: 命令行界面
    - 提供命令行交互功能

### 工具模块

11. **debugger**: 调试工具
    - 提供语法规则调试功能

12. **utility**: 工具函数
    - 提供各种辅助功能

13. **tagger**: 文本标记功能
    - 提供文本标记功能

14. **tool**: 附加工具
    - 提供其他辅助工具

15. **maven-plugin**: Maven 插件
    - 提供用于语法处理的 Maven 插件

## 功能特性

### 语法规则语法

项目使用自定义语法规则语法来定义语言模式：

1. **命名空间**:
   ```
   namespace weather;
   ```

2. **类型定义**:
   ```
   @type(name="singer")
   <singer>: ${singer|person};
   ```

3. **语句定义**:
   ```
   @attr(intention="播放歌曲")
   @statement
   play_music: ("播"? "放")? <singer> "的"? <song>;
   ```

4. **实体引用**:
   - `<singer>`: 引用之前定义的类型
   - `${singer}`: 引用预定义的实体类型

5. **操作符**:
   - `|`: 或操作符 (例如: `${singer|person}`)
   - `?`: 可选元素 (例如: `"的"?`)
   - `()`: 分组 (例如: `("播"? "放")?`)

### API 接口

#### Web API 端点

主服务器类 `GrammarServer.java` 提供以下 API:

##### POST /match

匹配输入文本与语法规则。

**请求体**:
- `input`: 要匹配的文本
- `context`: 上下文信息
- `meta`: 匹配过程的元数据

**响应**: 表示匹配结果的 `Semantic` 对象数组

#### 服务器配置

服务器配置包含以下属性:
- `nlp.grammar.path`: 语法目录路径（分号分隔）
- `spring.data.mongodb.uri`: 词汇数据的 MongoDB URI（可选）

## 部署方法

### Docker 部署

项目可以作为 Docker 容器部署。

#### 构建 Docker 镜像

```bash
docker build -t grammar-server:<版本号> .
```

#### 运行 Docker 容器

```bash
docker run -it --rm \
  -eTAGGING_SERVER_ADDR=<标记服务器IP> \
  -eTAGGING_SERVER_PORT=<标记服务器端口> \
  -p50058:50058 \
  -v <语法规则路径>:/grammar \
  grammar-server:<版本号>
```

#### 配置参数

容器需要以下环境变量:
- `TAGGING_SERVER_ADDR`: 标记服务器的 IP 地址
- `TAGGING_SERVER_PORT`: 标记服务器的端口

#### 卷挂载

语法规则应挂载到容器内的 `/grammar` 目录:
```
-v <语法规则路径>:/grammar
```

### Maven 构建

使用 Maven 构建项目:
```bash
mvn clean install
```

## 开发指南

### 项目结构

这是一个 Maven 多模块项目，遵循以下约定:

1. 每个模块遵循标准 Maven 目录结构:
   - `src/main/java`: Java 源代码
   - `src/main/resources`: 资源文件
   - `src/test/java`: 测试代码
   - `src/test/resources`: 测试资源

2. 包命名约定: `com.ecarx.ai.grammar.<模块名>`

### 主要依赖

项目的主要依赖在根 `pom.xml` 中定义:
- ANTLR: 用于解析语法
- Spring Boot: 用于 Web 服务
- gRPC: 用于 RPC 服务
- Jackson: 用于 JSON 处理 